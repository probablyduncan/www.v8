---
import BaseMetadata from "../components/head/base-metadata.astro";
import GlobalStylesLoader from "../components/head/global-styles-loader.astro";
import PageMetadata from "../components/head/page-metadata.astro";
import Image from "../components/image.astro";
import { getImage } from "../lib/images/imageDataHelper";
import { Content as TextContent } from "../content/horizons.md";

const entry = {
    id: "horizons",
    data: {
        title: "Horizons",
        images: [
            {
                key: "2021-10-15-DSC_0273.g.avif",
                horizon: 0.3089820359281437,
                marginCSS: "var(--padding) / 2",
            },
            {
                key: "2021-10-15-DSC_0050.g.avif",
                horizon: 0.2869318181818182,
                marginCSS: "20dvh",
            },
            {
                key: "2021-01-14-DSC_0024.g.avif",
                horizon: 0.3808724832214765,
                marginCSS: "40px",
            },
            {
                key: "2021-09-20-DSC_0198.g.avif",
                horizon: 0.7113772455089821,
                marginCSS: "20dvh",
            },
            {
                key: "2021-02-26-DSC_0481.g.avif",
                horizon: 0.5760479041916168,
                marginCSS: "var(--padding) * 2 / 3",
                // marginCSS: "20px",
            },
            {
                key: "2018-12-13-_DSC0008-2.g.avif",
                horizon: -0.5,
                marginCSS: "40px"
            },
            {
                key: "2021-11-19-DSC_0210.g.avif",
                horizon: 0.21551724137931033,
            },
            {
                key: "2021-11-13-DSC_0060.g.avif",
                horizon: 0.7389221556886227,
                // marginCSS: "40px",
            },
        ],
    },
};

const horizonLerp = 0.5;
---

<!doctype html>
<html lang="en">
    <head>
        <BaseMetadata />
        <GlobalStylesLoader />
        <PageMetadata
            title={`${entry.data.title} (on Duncan’s Website)`}
            desc="Yes, that’s right! This is his website! He is a London-based photographer, writer, and web developer from Milwaukee, Wisconsin. Come inside. Take off your coat. Stay a while."
        />
    </head>
    <body>
        <nav>
            <span>
                <a href="/" title="back! to the home page">Home</a>
                /
                <h1>
                    <a
                        href={entry.id}
                        title={entry.data.title.toLowerCase() +
                            " (you're already here!)"}>{entry.data.title}</a
                    >
                </h1>
            </span>
            <span>
                <a href="#text" title="Context">Text</a>
                <a href="#" title="Close Context">Close</a>
            </span>
        </nav>
        <!-- <div class="middle-line"></div> -->
        <main>
            {
                entry.data.images.map((_image) => {
                    const image = getImage(_image.key)!;

                    const globalHorizon = horizonLerp;
                    const imageHorizon = _image.horizon ?? 0.5;

                    const horizonAboveGlobal = imageHorizon > globalHorizon;

                    const hi = horizonAboveGlobal
                        ? imageHorizon
                        : 1 - imageHorizon;
                    const hg = horizonAboveGlobal
                        ? globalHorizon
                        : 1 - globalHorizon;

                    const bigPaddingSide = horizonAboveGlobal
                        ? "bottom"
                        : "top";
                    const smallPaddingSide = horizonAboveGlobal
                        ? "top"
                        : "bottom";

                    const paddingCSS = _image.marginCSS ?? "0px";

                    const totalHeightCSSCalc = `(100dvh - 2 * ${paddingCSS})`;
                    const widthCSS = `calc(${image.ratio} * ${hg} * ${totalHeightCSSCalc} / ${hi})`;
                    const bigPaddingCSS = `calc((1 - ${hg} / ${hi}) * ${totalHeightCSSCalc} + ${paddingCSS})`;

                    return (
                        <figure
                            style={`--hi: ${imageHorizon}; width: ${widthCSS}; margin-${bigPaddingSide}: ${bigPaddingCSS}; margin-${smallPaddingSide}: calc(${paddingCSS});`}
                        >
                            <Image data={image} />
                        </figure>
                    );
                })
            }
        </main>
        <aside id="text">
            <div>
                <TextContent />
            </div>
        </aside>
    </body>
</html>

<style>
    .middle-line {
        position: fixed;
        width: 100%;
        background-color: red;
        height: 2px;
        top: calc(40px + 20% - 16px - 1px);
        top: calc(50% - 1px);
        z-index: 100;
    }

    nav {
        position: fixed;
        z-index: 1;
        padding: calc(var(--padding) / 3) calc(var(--padding) / 2);

        width: 100%;
        display: flex;
        justify-content: space-between;

        user-select: none;
        -webkit-user-select: none;
        pointer-events: none;

        font-variant-numeric: lining-nums;
        font-variation-settings:
            "wght" 600,
            "wdth" 100,
            "ENLA" 20;

        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;

        @media screen and (max-width: 58ch) {
            flex-direction: column;
        }

        h1 {
            font-size: unset;
            display: inline;
            margin: 0;
        }

        a {
            color: unset;
            text-decoration: none;
            pointer-events: auto;
            user-select: auto;
            -webkit-user-select: auto;
        }

        a:hover,
        a:focus-visible {
            text-decoration: underline;
            text-decoration-thickness: 0.0875em;
            text-underline-offset: 0.125em;
        }

        a:focus-visible,
        a:active {
            outline: none;
            background-color: var(--color-primary);
            color: var(--color-bg);
        }

        a[href="#"] {
            display: none;
        }
    }

    main {
        padding-inline: calc(var(--padding) / 2);
        height: 100dvh;
        display: flex;
        flex-flow: row nowrap;
        gap: clamp(20vw, 20dvh, 50vw);
        overflow-y: hidden;
        overflow-x: scroll;

        --global-horizon: 0.5;
    }

    figure {
        flex-shrink: 0;

        position: relative;
        z-index: 2;

        opacity: 1;
        transform: none;
        filter: none;

        transition:
            box-shadow 0.5s,
            opacity 0.5s,
            transform 0.5s,
            filter 1s;
    }

    figure::after {
        /* content: ""; */
        height: 1px;
        position: absolute;
        width: 100%;
        top: calc(100% * var(--hi));
        background-color: green;
    }

    figure.off-screen {
        opacity: 0;
        transform: translate(10px, 20px) rotate(2deg);
        filter: blur(10px);
    }

    #text {
        position: fixed;
        inset: 0;
        z-index: 10;

        background-color: black;
        color: white;
        overflow-y: scroll;

        display: grid;
        grid-template-columns: 1fr auto 1.618fr;

        padding-block: 50vh;

        ::selection {
            color: black;
        }

        & > div {
            grid-column: 2;
            width: 50ch;
            max-width: 100%;
        }

        &:not(:target) {
            display: none;
        }
    }

    body:has(#text:target) nav {
        z-index: 12;
        color: white;

        a[href="#"] {
            display: unset;
        }

        a[href="#text"] {
            display: none;
        }
    }
</style>

<script>
    function initHorizons() {
        document.querySelectorAll("figure img").forEach((_e) => {
            const img = _e as HTMLImageElement;
            img.addEventListener("click", (e) => {
                e.stopPropagation();
                console.log(e.layerY / img.clientHeight);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", initHorizons);
</script>
