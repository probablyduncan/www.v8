---
import { shuffleRef } from "@probablyduncan/common/shuffle";
import { getCollection } from "astro:content";
import { resolveLink } from "../lib/linkHelper";

const links = await getCollection("ticker");
shuffleRef(links);

const animateSeconds = links.length * 30;
---

<nav
    style={`--animation-duration: ${animateSeconds}s; --animation-delay: -${animateSeconds / 2}s;`}
>
    {
        Array.from({ length: 2 }).map(() => (
            <span class="half">
                {links.map(({ data: link }) => {
                    const linkProps = resolveLink({
                        href: link.href,
                        innerHtml: link.text,
                    });
                    return (
                        <span
                            class="item"
                            style={`--rand: ${Math.floor(Math.random() * 10)};`}
                        >
                            <a {...linkProps} tabindex="-1">
                                {link.text}
                            </a>
                            <span>{link.text}</span>
                            <span>{link.text}</span>
                        </span>
                    );
                })}
            </span>
        ))
    }
</nav>
<style>

    /* container for link text and spacers */
    .item {
        display: inline-block;
        font-size: 1em;
        font-style: italic;

        display: inline-flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;

        /* between 0 and 9 */
        --rand: 0;
        margin-right: calc(var(--rand) * 0.2em + 5em);
    }

    /* ensure can interact with links, reset link styles */
    .item a {
        cursor: pointer;
        pointer-events: auto;
        text-decoration: unset;
        color: unset;
    }

    /* default link text settings */
    .item a,
    .item span:first-of-type {
        font-variation-settings:
            "wght" 300,
            "wdth" 100,
            "ENLA" 0;
    }

    /* enlarge link text on hover */
    @media (hover: hover) {
        .item a:hover,
        .item span:last-of-type {
            font-variation-settings:
                "wght" 300,
                "wdth" 80,
                "ENLA" 30;
        }
    }

    /* hide spacers */
    .item span:first-of-type,
    .item span:last-of-type {
        content: attr(data-content);
        height: 0;
        visibility: hidden;
        overflow: hidden;
        pointer-events: none;
    }

    .half {
        position: absolute;
        left: 0;
        top: 0;
        animation: tick var(--animation-duration) linear infinite;
    }

    /* delay second one half of duration */
    .half:last-of-type {
        animation-delay: var(--animation-delay);
    }

    nav {
        z-index: 100;
        pointer-events: none;
        position: fixed;
        display: inline;
        white-space: nowrap;
        top: -30px;
        left: 0px;
        transform: rotate(2deg);
        transform-origin: 0 0;

        user-select: none;
        -webkit-user-select: none;
    }

    /* pause ticker on hover */
    @media (hover: hover) {
        nav:has(.item:hover) .half {
            animation-play-state: paused;
        }
    }

    /* render ticker with borders/background on small screens */
    @media screen and (width < 512px) {
        nav {
            top: 0;
            transform: none;
        }

        .half {
            background-color: var(--color-bg);
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            padding-block: 0.2em;
            border-block: 0.125em double var(--color-text-lighter);
        }

        .item {
            margin-right: 1.2em;
        }
    }

    /* underline links on hover when desktop */
    @media screen and (hover: hover) and (width >= 512px) {
        .item a:hover {
            text-decoration: underline;
            text-underline-offset: 2px;
        }
    }

    @keyframes tick {
        from {
            transform: translateX(-100%);
        }

        to {
            transform: translateX(100%);
        }
    }
</style>
