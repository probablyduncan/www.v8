---
import type { HTMLAttributes } from "astro/types";
import Image from "./image.astro";
import { getImage } from "../lib/images/imageDataHelper";

interface Props extends HTMLAttributes<"img"> {
    data?: ImageMetadataRuntimeSchema;
}

const props = Astro.props;

// check if src is actually an image filename or friendly name
if (props.src) {
    const srcWithoutSlash = props.src.startsWith("/")
        ? props.src.replace("/", "")
        : props.src;

    const image = getImage(srcWithoutSlash);
    if (image) {
        props.src = undefined;
        props.data = image;

        // alt could be "" - make sure we use image's alt
        if (!props.alt) {
            props.alt = undefined;
        }
    }
}

const ratio = props.data?.ratio ?? 1
---

<figure style={`
    --sqrt-ratio: ${Math.sqrt(ratio).toFixed(5)};
`}>
    <Image {...props} />
    {props.title && <figcaption>{props.title}</figcaption>}
</figure>
<style>
    figure {
        margin-block: 2em;

        display: flex;
        flex-flow: column;
        align-items: center;

        max-width: calc(100vw - 2 * var(--padding));
        --sqrt-ratio: 1;
        width: calc(100% * var(--sqrt-ratio));

        /* this isn't right!! */
        /* margin-left: calc(29ch - 50% * var(--sqrt-ratio)); */
    }

    figure:first-child {
        margin-top: 0;
    }

    figcaption {
        margin-top: 0.5em;
        text-align: right;
        font-size: 0.9em;
        opacity: 0.6;

        font-variation-settings: "wdth" 75;
    }
</style>
